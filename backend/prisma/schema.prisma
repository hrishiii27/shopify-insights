generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id            String     @id @default(uuid())
  name          String
  shopifyDomain String     @unique
  shopifyApiKey String?
  shopifySecret String?
  accessToken   String?
  isActive      Boolean    @default(true)
  lastSyncAt    DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  users         User[]
  customers     Customer[]
  orders        Order[]
  products      Product[]
  events        Event[]
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("user")
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

model Customer {
  id           String   @id @default(uuid())
  shopifyId    String
  email        String?
  firstName    String?
  lastName     String?
  phone        String?
  totalSpent   Decimal  @default(0) @db.Decimal(12, 2)
  ordersCount  Int      @default(0)
  tags         String?
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders       Order[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  shopifyCreatedAt DateTime?

  @@unique([tenantId, shopifyId])
  @@index([tenantId])
  @@index([email])
}

model Order {
  id                String    @id @default(uuid())
  shopifyId         String
  orderNumber       String
  name              String?
  totalPrice        Decimal   @db.Decimal(12, 2)
  subtotalPrice     Decimal?  @db.Decimal(12, 2)
  totalTax          Decimal?  @db.Decimal(12, 2)
  totalDiscounts    Decimal?  @db.Decimal(12, 2)
  currency          String    @default("USD")
  financialStatus   String?
  fulfillmentStatus String?
  customerId        String?
  customer          Customer? @relation(fields: [customerId], references: [id])
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderDate         DateTime
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  lineItems         OrderLineItem[]

  @@unique([tenantId, shopifyId])
  @@index([tenantId])
  @@index([orderDate])
  @@index([customerId])
}

model OrderLineItem {
  id          String  @id @default(uuid())
  shopifyId   String
  orderId     String
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String?
  title       String
  quantity    Int
  price       Decimal @db.Decimal(12, 2)
  sku         String?
  variantId   String?

  @@index([orderId])
}

model Product {
  id          String   @id @default(uuid())
  shopifyId   String
  title       String
  handle      String?
  vendor      String?
  productType String?
  status      String   @default("active")
  tags        String?
  price       Decimal  @default(0) @db.Decimal(12, 2)
  compareAtPrice Decimal? @db.Decimal(12, 2)
  inventory   Int      @default(0)
  imageUrl    String?
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  shopifyCreatedAt DateTime?

  @@unique([tenantId, shopifyId])
  @@index([tenantId])
}

model Event {
  id          String   @id @default(uuid())
  type        String   // cart_abandoned, checkout_started, product_viewed, etc.
  source      String   @default("webhook")
  customerId  String?
  sessionId   String?
  payload     Json?
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@index([tenantId])
  @@index([type])
  @@index([createdAt])
}

model SyncLog {
  id        String   @id @default(uuid())
  tenantId  String
  type      String   // customers, orders, products
  status    String   // pending, running, completed, failed
  itemCount Int      @default(0)
  error     String?
  startedAt DateTime @default(now())
  completedAt DateTime?
}
